# Description: NVIDIA's GPU programming toolkit
# URL:         http://www.nvidia.com/object/cuda_home.html
# Packager:    onodera, onodera at openmailbox dot org
# Maintainer:  6c37 Team, https://github.com/6c37/crux-ports/issues
# Depends on:  

name=cuda
version=7.0.28
release=2
source=(
	http://developer.download.nvidia.com/compute/cuda/7_0/Prod/local_installers/cuda_${version}_linux.run
	cuda.sh
	cuda.conf
)

build() {
	sh cuda_${version}_linux.run -extract=$SRC
	./cuda-linux64-rel-*.run --noexec --keep
	./cuda-samples-linux-*.run --noexec --keep

	sed -e "s|/usr/share|$SRC/../pkg/cuda/usr/share|g" \
		-e 's|can_add_for_all_users;|1;|g' \
		-e 's|=\\"$prefix\\\"|=/opt/cuda|g' -e 's|Terminal=No|Terminal=false|g' -e 's|ParallelComputing|ParallelComputing;|g' \
		-i pkg/install-linux.pl

	sed 's|\$cudaprefix\\|\\/opt\\/cuda\\|g' -i pkg/install-sdk-linux.pl

	cd pkg

	perl install-linux.pl -prefix=$PKG/opt/cuda -noprompt
	perl install-sdk-linux.pl -cudaprefix=$PKG/opt/cuda -prefix=$PKG/opt/cuda/samples -noprompt

	sed -i "/unsupported GNU/d" $PKG/opt/cuda/include/host_config.h

	install -Dm755 $SRC/cuda.sh $PKG/etc/profile.d/cuda.sh
	install -Dm644 $SRC/cuda.conf $PKG/etc/ld.so.conf.d/cuda.conf

	rm -fr $PKG/opt/cuda/doc/man
	rm -fr $PKG/opt/cuda/cuda-samples
}

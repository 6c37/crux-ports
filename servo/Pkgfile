# Description: Parallel Browser Project: web browser written in Rust. (git checkout)
# URL:         https://github.com/mozilla/servo
# Packager:    onodera, onodera at openmailbox dot org
# Maintainer:  6c37 Team, https://github.com/6c37/crux-ports/issues
# Depends on:  git python xorg-libxmu virtualenv gperf cmake freetype xorg-libxrandr mesa3d xorg-libxi xorg-libxcursor glu

name=servo
version=git
release=1
source=(fix-build.patch)

build () {
	cd $PKGMK_SOURCE_DIR

	if cd $name; then
		git fetch -q; git reset --hard origin/master
	else
		git clone git://github.com/servo/servo $name
		cd $name
	fi

	# Fix https://github.com/servo/servo/issues/5917
	patch -p1 < $SRC/fix-build.patch

	./mach build --release

	install -Dm755 servo/components/servo/target/release/servo $PKG/usr/bin/servo

	mkdir -p $PKG/usr/lib
	find servo/components/servo/target/release/deps -name "*-*.so" -exec basename {} \; | sort | uniq | while read _f; do
		_file=$(find servo/components/servo/target/release/deps -name "$_f" -print | head -n 1)
		if [ -z "$_file" ]; then
			echo "Skipping: $_f"
			continue
		fi
		install -Dm644 $_file $PKG/usr/lib
	done
}
